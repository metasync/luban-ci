apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: luban-ci-dind-template
  namespace: luban-ci
spec:
  entrypoint: ci-pipeline
  serviceAccountName: luban-ci-sa
  arguments:
    parameters:
    - name: repo_url
    - name: revision
    - name: app_name
    - name: quay_namespace
      value: "luban-ci"
    - name: stack_tag
      value: "al2023"

  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi

  templates:
  - name: ci-pipeline
    steps:
    - - name: checkout
        template: git-checkout
    - - name: build-and-push
        template: build-push

  - name: git-checkout
    container:
      image: alpine/git
      command: [sh, -c]
      args:
      - |
        # Configure git credentials
        git config --global credential.helper store
        echo "https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
        
        echo "Cloning ${REPO_URL}..."
        git clone ${REPO_URL} /workdir/repo
        cd /workdir/repo
        git checkout ${REVISION}
      env:
      - name: GITHUB_USERNAME
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: username
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: token
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: build-push
    container:
      image: ubuntu:22.04
      command: [bash, -c]
      args:
      - |
        apt-get update && apt-get install -y curl ca-certificates
        
        # Install pack
        curl -sSL "https://github.com/buildpacks/pack/releases/download/v0.32.1/pack-v0.32.1-linux.tgz" | tar -C /usr/local/bin/ -xzv pack
        
        echo "Building {{workflow.parameters.app_name}}..."
        # Set PACK_HOME to a writable location
        export PACK_HOME=/workdir/.pack
        
        # Build and push
        # Using the builder image from Quay
        pack build quay.io/{{workflow.parameters.quay_namespace}}/{{workflow.parameters.app_name}}:{{workflow.parameters.revision}} \
          --path /workdir/repo/{{workflow.parameters.app_name}} \
          --builder quay.io/{{workflow.parameters.quay_namespace}}/luban-builder:{{workflow.parameters.stack_tag}} \
          --run-image quay.io/{{workflow.parameters.quay_namespace}}/luban-run:{{workflow.parameters.stack_tag}} \
          --publish
      env:
      - name: DOCKER_HOST
        value: "tcp://localhost:2375"
      volumeMounts:
      - name: workdir
        mountPath: /workdir
      - name: docker-config
        mountPath: /root/.docker/
    sidecars:
    - name: dind
      image: docker:24-dind
      securityContext:
        privileged: true
      env:
      - name: DOCKER_TLS_CERTDIR
        value: ""
      mirrorVolumeMounts: true

    volumes:
    - name: docker-config
      secret:
        secretName: quay-creds
        items:
        - key: .dockerconfigjson
          path: config.json
