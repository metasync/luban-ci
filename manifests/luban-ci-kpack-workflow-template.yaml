apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: luban-ci-kpack-template
  namespace: luban-ci
spec:
  entrypoint: ci-pipeline
  serviceAccountName: luban-ci-sa
  synchronization:
    semaphore:
      configMapKeyRef:
        name: workflow-semaphores
        key: kpack-builds
  arguments:
    parameters:
    - name: repo_url
      description: "URL of the source code repository"
    - name: revision
      description: "Commit revision to build"
    - name: app_name
      description: "Name of the application"
    - name: sub_path
      description: "Sub-path within the repository to build"
      value: ""
    - name: git_ref
      description: "Git reference (branch or tag)"
      value: ""
    - name: tag
      description: "Explicit image tag to use (overrides revision)"
      value: ""
    - name: git_provider
      description: "Git Provider (e.g., 'github', 'gitlab')"
      value: "github"
    - name: git_creds_secret
      description: "Name of the secret containing git credentials"
      value: "github-creds"
    - name: registry_server
      description: "Registry server to push image to"
      valueFrom:
        configMapKeyRef:
          name: luban-config
          key: registry_server
          optional: true
    - name: gitops_branch
      description: "Branch in GitOps repo to update (usually 'develop')"
      value: "develop"
    - name: deploy_env
      description: "Deployment environment (e.g., 'snd', 'prd')"
      value: "snd"
    - name: gitops_utils_image
      description: "Image for GitOps utility tools"
      value: "quay.io/luban-ci/gitops-utils:0.3.3"
    - name: default_image_name
      description: "Default placeholder image name to replace"
      valueFrom:
        configMapKeyRef:
          name: luban-config
          key: default_image_name
          optional: true
    - name: default_image_tag
      description: "Default placeholder image tag to replace"
      valueFrom:
        configMapKeyRef:
          name: luban-config
          key: default_image_tag
          optional: true

  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi

  templates:
  - name: ci-pipeline
    steps:
    # 1. Determine Organization from Repo URL
    - - name: determine-org
        templateRef:
          name: gitops-helper-template
          template: extract-org-from-url
        arguments:
          parameters:
          - name: repo_url
            value: "{{workflow.parameters.repo_url}}"
          - name: git_provider
            value: "{{workflow.parameters.git_provider}}"

    - - name: checkout
        template: git-checkout
    - - name: build-and-push
        template: build-push
        arguments:
          parameters:
          - name: registry_namespace
            value: "{{steps.determine-org.outputs.parameters.organization}}"
    
    # New step: Determine GitOps Repo URL
    - - name: determine-gitops-url
        templateRef:
          name: gitops-helper-template
          template: get-repo-url
        arguments:
          parameters:
          - name: git_provider
            value: "{{workflow.parameters.git_provider}}"
          - name: git_organization
            value: "{{steps.determine-org.outputs.parameters.organization}}"
          - name: application_name
            value: "{{workflow.parameters.app_name}}"

    - - name: update-gitops
        template: git-update
        arguments:
          parameters:
          - name: image_tag
            value: "{{steps.build-and-push.outputs.parameters.image_tag}}"
          - name: gitops_repo_url
            value: "{{steps.determine-gitops-url.outputs.parameters.repo_url}}"
          - name: registry_namespace
            value: "{{steps.determine-org.outputs.parameters.organization}}"
          - name: default_image_name
            value: "{{workflow.parameters.default_image_name}}"
          - name: default_image_tag
            value: "{{workflow.parameters.default_image_tag}}"

  - name: git-checkout
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        # Configure git credentials
        git config --global credential.helper store
        # Extract domain from REPO_URL
        DOMAIN=$(echo "$REPO_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        echo "https://${GIT_USERNAME}:${GIT_TOKEN}@${DOMAIN}" > ~/.git-credentials

        echo "Cloning ${REPO_URL}..."
        git clone ${REPO_URL} /workdir/repo
        cd /workdir/repo
        git checkout ${REVISION}
      env:
      - name: GIT_USERNAME
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: username
      - name: GIT_TOKEN
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: token
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: build-push
    inputs:
      parameters:
      - name: registry_namespace
    outputs:
      parameters:
      - name: image_tag
        valueFrom:
          path: /tmp/image_tag
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        # Create or Update kpack Image resource and wait for build
        echo "Upserting kpack Image for {{workflow.parameters.app_name}}..."
        
        # Prepare optional flags
        SUB_PATH="{{workflow.parameters.sub_path}}"
        SUB_PATH_FLAG=""
        if [ -n "$SUB_PATH" ]; then
          SUB_PATH_FLAG="--sub-path $SUB_PATH"
        fi
        
        IMAGE_TAG="$REVISION"
        if [ -n "$TAG" ]; then
          IMAGE_TAG="$TAG"
        elif printf "%s" "$GIT_REF" | grep -q '^refs/tags/'; then
          IMAGE_TAG="${GIT_REF#refs/tags/}"
        fi
        
        # Strip 'v' prefix if present (e.g., v0.1.0 -> 0.1.0)
        IMAGE_TAG="${IMAGE_TAG#v}"
        echo -n "$IMAGE_TAG" > /tmp/image_tag
        
        TAG_ARGS=""
        if [ "$IMAGE_TAG" != "$REVISION" ]; then
          TAG_ARGS="--tag ${registry_server}/${registry_namespace}/${APP_NAME}:$IMAGE_TAG"
        fi
        
        kp image save "$APP_NAME" \
          --tag ${registry_server}/${registry_namespace}/${APP_NAME}:$REVISION \
          $TAG_ARGS \
          --builder luban-builder \
          --git "$REPO_URL" \
          --git-revision "$REVISION" \
          $SUB_PATH_FLAG \
          --service-account luban-ci-sa \
          --namespace luban-ci \
          --wait
      env:
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: TAG
        value: "{{workflow.parameters.tag}}"
      - name: GIT_REF
        value: "{{workflow.parameters.git_ref}}"
      - name: registry_server
        value: "{{workflow.parameters.registry_server}}"
      - name: registry_namespace
        value: "{{inputs.parameters.registry_namespace}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: git-update
    inputs:
      parameters:
      - name: image_tag
      - name: gitops_repo_url
      - name: registry_namespace
      - name: default_image_name
      - name: default_image_tag
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        git config --global credential.helper store
        # Extract domain from GITOPS_REPO_URL
        DOMAIN=$(echo "$GITOPS_REPO_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        echo "https://${GIT_USERNAME}:${GIT_TOKEN}@${DOMAIN}" > ~/.git-credentials
        git config --global user.email "ci@luban.com"
        git config --global user.name "Luban CI"

        echo "Cloning ${GITOPS_REPO_URL}..."
        git clone ${GITOPS_REPO_URL} /workdir/gitops
        cd /workdir/gitops
        if git show-ref --verify --quiet "refs/heads/${GITOPS_BRANCH}"; then \
          git checkout ${GITOPS_BRANCH}; \
        else \
          if git ls-remote --exit-code --heads origin ${GITOPS_BRANCH} >/dev/null 2>&1; then \
            git checkout -b ${GITOPS_BRANCH} origin/${GITOPS_BRANCH}; \
          else \
            git checkout -b ${GITOPS_BRANCH}; \
            git push -u origin ${GITOPS_BRANCH}; \
          fi; \
        fi
        
        KUST_PATH="app/overlays/${DEPLOY_ENV}/kustomization.yaml"
        BASE_DIR="app/base"
        APP_IMAGE_NAME="${registry_server}/${registry_namespace}/${APP_NAME}"
        export APP_IMAGE_NAME
        IMAGE_TAG="{{inputs.parameters.image_tag}}"
        export IMAGE_TAG
        DEFAULT_IMAGE_NAME="{{inputs.parameters.default_image_name}}"
        
        echo "Updating GitOps repo..."
        
        # 1. Replace Placeholder Image Name (Day 1 Migration)
        if [ -n "$DEFAULT_IMAGE_NAME" ]; then
           echo "Checking for default image placeholder: $DEFAULT_IMAGE_NAME"
           
           # Replace in Base (Deployment and Kustomization)
           if [ -d "$BASE_DIR" ]; then
              if grep -r "$DEFAULT_IMAGE_NAME" "$BASE_DIR" >/dev/null 2>&1; then
                 echo "Replacing placeholder in Base..."
                 find "$BASE_DIR" -name "*.yaml" -type f -exec sed -i "s|$DEFAULT_IMAGE_NAME|$APP_IMAGE_NAME|g" {} +
              fi
           fi
           
           # Replace in Overlay (Kustomization)
           if [ -f "$KUST_PATH" ]; then
              if grep "$DEFAULT_IMAGE_NAME" "$KUST_PATH" >/dev/null 2>&1; then
                 echo "Replacing placeholder in Overlay..."
                 sed -i "s|$DEFAULT_IMAGE_NAME|$APP_IMAGE_NAME|g" "$KUST_PATH"
              fi
           fi
        fi
        
        # 2. Update Image Tag
        echo "Updating image tag to $IMAGE_TAG..."
        if yq -e '.images[] | select(.name == env(APP_IMAGE_NAME))' "$KUST_PATH" >/dev/null 2>&1; then
           yq -i '(.images[] | select(.name == env(APP_IMAGE_NAME))).newTag = env(IMAGE_TAG)' "$KUST_PATH"
        else
           # Fallback: Initialize images list if empty or missing
           if [ "$(yq '.images | length' "$KUST_PATH")" = "0" ]; then
              echo "Initializing Overlay images list..."
              yq -i ".images += [{\"name\": env(APP_IMAGE_NAME), \"newTag\": env(IMAGE_TAG)}]" "$KUST_PATH"
           else
              # Images list exists but no match found. Append new entry.
              echo "Image entry not found. Appending..."
              yq -i ".images += [{\"name\": env(APP_IMAGE_NAME), \"newTag\": env(IMAGE_TAG)}]" "$KUST_PATH"
           fi
        fi
        
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add .
          git commit -m "Update ${APP_NAME} ${DEPLOY_ENV} image tag to ${IMAGE_TAG}"
          git push
        fi
      env:
      - name: GIT_USERNAME
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: username
      - name: GIT_TOKEN
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: token
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      - name: TAG
        value: "{{workflow.parameters.tag}}"
      - name: GIT_REF
        value: "{{workflow.parameters.git_ref}}"
      - name: GITOPS_REPO_URL
        value: "{{inputs.parameters.gitops_repo_url}}"
      - name: GITOPS_BRANCH
        value: "{{workflow.parameters.gitops_branch}}"
      - name: DEPLOY_ENV
        value: "{{workflow.parameters.deploy_env}}"
      - name: registry_server
        value: "{{workflow.parameters.registry_server}}"
      - name: registry_namespace
        value: "{{inputs.parameters.registry_namespace}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir
