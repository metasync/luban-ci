apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: luban-ci-kpack-template
  namespace: luban-ci
spec:
  entrypoint: ci-pipeline
  serviceAccountName: luban-ci-sa
  arguments:
    parameters:
    - name: repo_url
    - name: revision
    - name: app_name
    - name: quay_namespace
      value: "luban-ci"
    - name: sub_path
      value: ""
    - name: gitops_repo_url

  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi

  templates:
  - name: ci-pipeline
    steps:
    - - name: checkout
        template: git-checkout
    - - name: build-and-push
        template: build-push
    - - name: update-gitops
        template: git-update

  - name: git-checkout
    container:
      image: alpine/git
      command: [sh, -c]
      args:
      - |
        # Configure git credentials
        git config --global credential.helper store
        echo "https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com" > ~/.git-credentials

        echo "Cloning ${REPO_URL}..."
        git clone ${REPO_URL} /workdir/repo
        cd /workdir/repo
        git checkout ${REVISION}
      env:
      - name: GITHUB_USERNAME
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: username
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: token
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: build-push
    container:
      image: kpack/kp:latest
      command: [sh, -c]
      args:
      - |
        # Create or Update kpack Image resource and wait for build
        echo "Upserting kpack Image for {{workflow.parameters.app_name}}..."
        
        # Prepare optional flags
        SUB_PATH="{{workflow.parameters.sub_path}}"
        SUB_PATH_FLAG=""
        if [ -n "$SUB_PATH" ]; then
          SUB_PATH_FLAG="--sub-path $SUB_PATH"
        fi

        kp image save {{workflow.parameters.app_name}} \
          --tag quay.io/{{workflow.parameters.quay_namespace}}/{{workflow.parameters.app_name}}:{{workflow.parameters.revision}} \
          --builder luban-builder \
          --git {{workflow.parameters.repo_url}} \
          --git-revision {{workflow.parameters.revision}} \
          $SUB_PATH_FLAG \
          --service-account luban-ci-sa \
          --namespace luban-ci \
          --wait
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: git-update
    container:
      image: alpine/git
      command: [sh, -c]
      args:
      - |
        # Configure git credentials
        git config --global credential.helper store
        echo "https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
        
        git config --global user.email "ci@luban.com"
        git config --global user.name "Luban CI"

        echo "Cloning ${GITOPS_REPO_URL}..."
        git clone ${GITOPS_REPO_URL} /workdir/gitops
        cd /workdir/gitops
        
        echo "Updating deployment manifest..."
        sed -i "s|image: quay.io/${QUAY_NAMESPACE}/${APP_NAME}:.*|image: quay.io/${QUAY_NAMESPACE}/${APP_NAME}:${REVISION}|g" app/base/deployment.yaml
        
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add app/base/deployment.yaml
          git commit -m "Update ${APP_NAME} image tag to ${REVISION}"
          git push
        fi
      env:
      - name: GITHUB_USERNAME
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: username
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: github-creds
            key: token
      - name: GITOPS_REPO_URL
        value: "{{workflow.parameters.gitops_repo_url}}"
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: QUAY_NAMESPACE
        value: "{{workflow.parameters.quay_namespace}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir
