apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: argocd-app-setup-template
  namespace: luban-ci
spec:
  entrypoint: create-applications
  serviceAccountName: luban-ci-sa
  arguments:
    parameters:
    - name: project_name
      description: "Name of the project/team (e.g., 'payment')"
    - name: app_name
      description: "Name of the application (e.g., 'cart-service')"
    - name: environment
      description: "Target environment (e.g., 'snd', 'prd')"
      value: "snd"
    - name: git_organization
      description: "Git Organization/User (defaults to project_name if empty)"
      value: ""
    - name: git_provider
      description: "Git Provider (e.g., 'github', 'gitlab')"
      value: "github"
    - name: gitops_utils_image
      description: "Image for GitOps utility tools"
      value: "quay.io/luban-ci/gitops-utils:0.3.3"
  templates:
  - name: create-applications
    steps:
    - - name: ensure-application
        template: ensure-application
        arguments:
          parameters:
          - name: environment
            value: "{{workflow.parameters.environment}}"
          - name: app_name
            value: "{{workflow.parameters.app_name}}"
          - name: project_name
            value: "{{workflow.parameters.project_name}}"
          - name: git_provider
            value: "{{workflow.parameters.git_provider}}"
          - name: git_organization
            value: "{{workflow.parameters.git_organization}}"

  - name: ensure-application
    inputs:
      parameters:
      - name: environment
      - name: app_name
      - name: project_name
      - name: git_provider
      - name: git_organization
    steps:
    - - name: check-exists
        template: check-app-exists
        arguments:
          parameters:
          - name: environment
            value: "{{inputs.parameters.environment}}"
          - name: app_name
            value: "{{inputs.parameters.app_name}}"
    - - name: create-app
        template: create-app-resource
        arguments:
          parameters:
          - name: environment
            value: "{{inputs.parameters.environment}}"
          - name: app_name
            value: "{{inputs.parameters.app_name}}"
          - name: project_name
            value: "{{inputs.parameters.project_name}}"
          - name: git_provider
            value: "{{inputs.parameters.git_provider}}"
          - name: git_organization
            value: "{{inputs.parameters.git_organization}}"
        when: "{{steps.check-exists.outputs.result}} == false"

  - name: check-app-exists
    inputs:
      parameters:
      - name: environment
      - name: app_name
    script:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh]
      source: |
        APP_NAME="{{inputs.parameters.environment}}-{{inputs.parameters.app_name}}"
        echo "Checking if ArgoCD application $APP_NAME exists..." >&2
        if kubectl get application $APP_NAME -n argocd > /dev/null 2>&1; then
          echo "Application $APP_NAME already exists." >&2
          echo "true"
        else
          echo "Application $APP_NAME does not exist." >&2
          echo "false"
        fi

  - name: create-app-resource
    inputs:
      parameters:
      - name: environment
      - name: app_name
      - name: project_name
      - name: git_provider
      - name: git_organization
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        # Calculate derived parameters in shell for robustness
        ORG="{{inputs.parameters.git_organization}}"
        if [ -z "$ORG" ]; then
          ORG="{{inputs.parameters.project_name}}"
        fi
        
        REVISION="main"
        if [ "{{inputs.parameters.environment}}" = "snd" ]; then
          REVISION="develop"
        fi
        
        REPO_URL="https://{{inputs.parameters.git_provider}}.com/${ORG}/{{inputs.parameters.app_name}}-gitops.git"
        
        # Determine Sync Policy
        SYNC_POLICY_BLOCK=""
        if [ "{{inputs.parameters.environment}}" != "prd" ]; then
          SYNC_POLICY_BLOCK="automated:
              prune: true
              selfHeal: true"
        fi
        
        echo "Creating Application {{inputs.parameters.environment}}-{{inputs.parameters.app_name}}..."
        
        cat <<EOF | kubectl apply -f -
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: {{inputs.parameters.environment}}-{{inputs.parameters.app_name}}
          namespace: argocd
        spec:
          project: {{inputs.parameters.environment}}-{{inputs.parameters.project_name}}
          source:
            repoURL: ${REPO_URL}
            targetRevision: ${REVISION}
            path: app/overlays/{{inputs.parameters.environment}}
          destination:
            server: https://kubernetes.default.svc
            namespace: {{inputs.parameters.environment}}-{{inputs.parameters.project_name}}
          syncPolicy:
            ${SYNC_POLICY_BLOCK}
            syncOptions:
              - CreateNamespace=true
        EOF
