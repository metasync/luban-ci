apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: source-repo-provision-template
  namespace: luban-ci
spec:
  entrypoint: provision-source-repo
  serviceAccountName: luban-ci-sa
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 100Mi
  arguments:
    parameters:
      - name: project_name
        description: "Name of the project/team (e.g. dataops)"
      - name: application_name
        description: "Name of the application"
      - name: git_organization
        description: "Git Organization/User"
        value: "metasync"
      - name: git_provider
        description: "Git Provider (github, gitlab, etc.)"
        value: "github"
        enum:
          - "github"
          - "azure"
      - name: luban_provisioner_image
        description: "Image for Luban provisioner tool"
        value: "quay.io/luban-ci/luban-provisioner:0.1.45"
      - name: webhook_url
        description: "Webhook URL for CI integration"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: webhook_url
            optional: true

  templates:
    - name: provision-source-repo
      inputs:
        parameters:
          - name: project_name
          - name: application_name
          - name: git_organization
          - name: git_provider
          - name: luban_provisioner_image
          - name: webhook_url
      
      dag:
        tasks:
          - name: provision-repo
            template: provision-repo
            arguments:
              parameters:
                - name: project_name
                  value: "{{inputs.parameters.project_name}}"
                - name: application_name
                  value: "{{inputs.parameters.application_name}}"
                - name: git_organization
                  value: "{{inputs.parameters.git_organization}}"
                - name: git_provider
                  value: "{{inputs.parameters.git_provider}}"
                - name: luban_provisioner_image
                  value: "{{inputs.parameters.luban_provisioner_image}}"
                - name: webhook_url
                  value: "{{inputs.parameters.webhook_url}}"

    - name: provision-repo
      inputs:
        parameters:
          - name: project_name
          - name: application_name
          - name: git_organization
          - name: git_provider
          - name: luban_provisioner_image
          - name: webhook_url
      container:
        image: "{{inputs.parameters.luban_provisioner_image}}"
        imagePullPolicy: Always
        command: ["sh", "-c"]
        args:
          - |
            # Resolve Git Server Domain from Environment Variables
            GIT_SERVER="github.com" # Default fallback
            if [ "{{inputs.parameters.git_provider}}" = "azure" ]; then
               GIT_SERVER="${AZURE_SERVER:-dev.azure.com}"
            elif [ "{{inputs.parameters.git_provider}}" = "github" ]; then
               GIT_SERVER="${GITHUB_SERVER:-github.com}"
            fi

            python3 /app/src/main.py source \
              --project-name "{{inputs.parameters.project_name}}" \
              --application-name "{{inputs.parameters.application_name}}" \
              --output-dir "/workdir" \
              --git-organization "{{inputs.parameters.git_organization}}" \
              --git-provider "{{inputs.parameters.git_provider}}" \
              --webhook-url "{{inputs.parameters.webhook_url}}" \
              --git-server "$GIT_SERVER"
        env:
          - name: GITHUB_SERVER
            valueFrom:
              configMapKeyRef:
                name: luban-config
                key: github_server
                optional: true
          - name: AZURE_SERVER
            valueFrom:
              configMapKeyRef:
                name: luban-config
                key: azure_server
                optional: true
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-creds
                key: token
                optional: true
          - name: AZURE_DEVOPS_TOKEN
            valueFrom:
              secretKeyRef:
                name: azure-creds
                key: token
                optional: true
          - name: WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: webhook-secret
                key: secret
                optional: true
        volumeMounts:
          - name: workdir
            mountPath: /workdir
