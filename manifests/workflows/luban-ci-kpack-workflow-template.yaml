apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: luban-ci-kpack-template
  # Cluster resources do not have a namespace
spec:
  entrypoint: ci-pipeline
  serviceAccountName: luban-ci-sa
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  # Keep pods until the workflow is deleted to ensure logs are available
  podGC:
    strategy: OnWorkflowDeletion
  # Automatically delete the workflow (and pods) after a delay to clean up
  ttlStrategy:
    secondsAfterCompletion: 86400 # 24 hours
    secondsAfterSuccess: 3600     # 1 hour (clean up successful runs faster)
    secondsAfterFailure: 86400    # 24 hours (keep failed runs longer)
  synchronization:
    semaphore:
      configMapKeyRef:
        name: workflow-semaphores
        key: kpack-builds
  arguments:
    parameters:
    - name: repo_url
      description: "URL of the source code repository"
    - name: registry_namespace
      description: "Organization/Namespace for the registry (e.g., 'metasync')"
    - name: revision
      description: "Commit revision to build"
    - name: app_name
      description: "Name of the application"
    - name: sub_path
      description: "Sub-path within the repository to build"
      value: ""
    - name: git_ref
      description: "Git reference (branch or tag)"
      value: ""
    - name: tag
      description: "Explicit image tag to use (overrides revision)"
      value: ""
    - name: git_provider
      description: "Git Provider (e.g., 'github', 'gitlab')"
      value: "github"
    - name: git_creds_secret
      description: "Name of the secret containing git credentials"
      value: "github-creds"
    - name: registry_server
      description: "Registry server to push image to"
      valueFrom:
        configMapKeyRef:
          name: luban-config
          key: registry_server
          optional: true
    - name: gitops_branch
      description: "Branch in GitOps repo to update (usually 'develop')"
      value: "develop"
    - name: deploy_env
      description: "Deployment environment (e.g., 'snd', 'prd')"
      value: "snd"
    - name: gitops_utils_image
      description: "Image for GitOps utility tools"
      valueFrom:
        configMapKeyRef:
          name: luban-config
          key: gitops_utils_image

  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi

  templates:
  - name: ci-pipeline
    steps:
    - - name: build-push-by-commit
        template: build-push-by-commit
        when: "'{{workflow.parameters.git_ref}}' !~ '^refs/tags/'"
        arguments:
          parameters:
          - name: namespace
            value: "{{workflow.parameters.registry_namespace}}"
      - name: build-push-by-tag
        template: build-push-by-tag
        when: "'{{workflow.parameters.git_ref}}' =~ '^refs/tags/'"
        arguments:
          parameters:
          - name: namespace
            value: "{{workflow.parameters.registry_namespace}}"
    
    - - name: update-gitops
        template: git-update
        arguments:
          parameters:
          - name: namespace
            value: "{{workflow.parameters.registry_namespace}}"

  - name: build-push-by-commit
    inputs:
      parameters:
      - name: namespace
    outputs:
      parameters:
      - name: image_tag
        valueFrom:
          path: /tmp/image_tag
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        set -e
        set -o pipefail
        
        # Setup Kubeconfig for kp CLI
        mkdir -p ~/.kube
        kubectl config set-cluster local --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        kubectl config set-credentials luban --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
        kubectl config set-context local --cluster=local --user=luban --namespace="$NAMESPACE"
        kubectl config use-context local
        
        # Calculate derived parameters in shell for robustness
        REGISTRY_NAMESPACE="{{inputs.parameters.namespace}}"
        
        # Convert Azure DevOps HTTPS URL to SSH if needed
        # HTTPS: https://dev.azure.com/{org}/{project}/_git/{repo}
        # SSH:   git@ssh.dev.azure.com:v3/{org}/{project}/{repo}
        if echo "$REPO_URL" | grep -q "dev.azure.com"; then
           echo "Detected Azure DevOps URL. Converting to SSH format..."
           # Remove https:// and dev.azure.com/
           PATH_PART=$(echo "$REPO_URL" | sed -E 's|https://dev.azure.com/||')
           # Replace /_git/ with /
           PATH_PART=$(echo "$PATH_PART" | sed -E 's|/_git/|/|')
           REPO_URL="git@ssh.dev.azure.com:v3/$PATH_PART"
           echo "Converted URL: $REPO_URL"
        fi

        # Build for Regular Commit
        echo "Processing regular commit build for {{workflow.parameters.app_name}}..."
        
        # Use explicit tag if provided, otherwise use revision
        IMAGE_TAG="${TAG:-$REVISION}"
        echo -n "$IMAGE_TAG" > /tmp/image_tag
        
        echo "Source Revision:  $REVISION"
        echo "Target Image Tag: $IMAGE_TAG"

        BASE_IMAGE_NAME="${registry_server}/${REGISTRY_NAMESPACE}/${APP_NAME}"
        
        # Prepare optional sub-path
        SUB_PATH_FLAG_VALUE="{{workflow.parameters.sub_path}}"

        # Execute the save command using kubectl apply (to avoid kp CLI in-cluster config issues)
        cat <<EOF | kubectl apply -f -
        apiVersion: kpack.io/v1alpha2
        kind: Image
        metadata:
          name: $APP_NAME
        spec:
          tag: ${BASE_IMAGE_NAME}:latest
          additionalTags:
          - ${BASE_IMAGE_NAME}:${IMAGE_TAG}
          builder:
            kind: ClusterBuilder
            name: luban-builder
          source:
            git:
              url: "$REPO_URL"
              revision: "$REVISION"
            subPath: "$SUB_PATH_FLAG_VALUE"
          serviceAccountName: workflow-runner
        EOF
        
        echo "Image resource updated. Waiting for propagation..."
        sleep 5

        echo "Following build logs..."
        # Tail logs of the latest build
        kp build logs "$APP_NAME"

      env:
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: TAG
        value: "{{workflow.parameters.tag}}"
      - name: registry_server
        value: "{{workflow.parameters.registry_server}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: build-push-by-tag
    inputs:
      parameters:
      - name: namespace
    outputs:
      parameters:
      - name: image_tag
        valueFrom:
          path: /tmp/image_tag
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        set -e
        set -o pipefail

        # Setup Kubeconfig for kp CLI
        mkdir -p ~/.kube
        kubectl config set-cluster local --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        kubectl config set-credentials luban --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
        kubectl config set-context local --cluster=local --user=luban --namespace="$NAMESPACE"
        kubectl config use-context local

        # Calculate derived parameters in shell for robustness
        REGISTRY_NAMESPACE="{{inputs.parameters.namespace}}"

        # Convert Azure DevOps HTTPS URL to SSH if needed
        # HTTPS: https://dev.azure.com/{org}/{project}/_git/{repo}
        # SSH:   git@ssh.dev.azure.com:v3/{org}/{project}/{repo}
        if echo "$REPO_URL" | grep -q "dev.azure.com"; then
           echo "Detected Azure DevOps URL. Converting to SSH format..."
           # Remove https:// and dev.azure.com/
           PATH_PART=$(echo "$REPO_URL" | sed -E 's|https://dev.azure.com/||')
           # Replace /_git/ with /
           PATH_PART=$(echo "$PATH_PART" | sed -E 's|/_git/|/|')
           REPO_URL="git@ssh.dev.azure.com:v3/$PATH_PART"
           echo "Converted URL: $REPO_URL"
        fi

        # Tag Push Workflow
        echo "Processing tag push for {{workflow.parameters.app_name}}..."
        
        # Extract tag name and strip 'v' prefix (e.g. refs/tags/v1.0.0 -> 1.0.0)
        IMAGE_TAG="${GIT_REF#refs/tags/}"
        IMAGE_TAG="${IMAGE_TAG#v}"
        echo -n "$IMAGE_TAG" > /tmp/image_tag
        
        echo "Source Revision:  $REVISION"
        echo "Target Image Tag: $IMAGE_TAG"

        BASE_IMAGE_NAME="${registry_server}/${REGISTRY_NAMESPACE}/${APP_NAME}"
        
        # Prepare optional sub-path
        SUB_PATH_FLAG_VALUE="{{workflow.parameters.sub_path}}"

        echo "Detected Git Tag Push ($GIT_REF). Updating tags..."
        
        # Execute the save command using kubectl apply
        cat <<EOF | kubectl apply -f -
        apiVersion: kpack.io/v1alpha2
        kind: Image
        metadata:
          name: $APP_NAME
        spec:
          tag: ${BASE_IMAGE_NAME}:latest
          additionalTags:
          - ${BASE_IMAGE_NAME}:${REVISION}
          - ${BASE_IMAGE_NAME}:${IMAGE_TAG}
          builder:
            kind: ClusterBuilder
            name: luban-builder
          source:
            git:
              url: "$REPO_URL"
              revision: "$REVISION"
            subPath: "$SUB_PATH_FLAG_VALUE"
          serviceAccountName: workflow-runner
          build:
            env:
            - name: CI_TAG_UPDATE
              value: "${IMAGE_TAG}"
        EOF
        
        echo "Image resource updated. Waiting for propagation..."
        sleep 5
        
        echo "Following build logs..."
        # Tail logs of the latest build (which should be the one triggered by the update)
        kp build logs "$APP_NAME"

      env:
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: GIT_REF
        value: "{{workflow.parameters.git_ref}}"
      - name: registry_server
        value: "{{workflow.parameters.registry_server}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir

  - name: git-update
    inputs:
      parameters:
      - name: namespace
    container:
      image: "{{workflow.parameters.gitops_utils_image}}"
      command: [sh, -c]
      args:
      - |
        # Configure safe directory to avoid "fatal: detected dubious ownership"
        git config --global --add safe.directory "*"
        
        # Calculate derived parameters in shell for robustness
        REGISTRY_NAMESPACE="{{inputs.parameters.namespace}}"
        # Determine GitOps Repo URL
        if [ "$GIT_PROVIDER" = "azure" ]; then
           # Extract org/project from REPO_URL (SSH or HTTPS)
           # SSH: git@ssh.dev.azure.com:v3/{org}/{project}/{repo}
           # HTTPS: https://dev.azure.com/{org}/{project}/_git/{repo}
           
           if echo "$REPO_URL" | grep -q "ssh.dev.azure.com"; then
             # Remove prefix up to v3/
             BASE_PATH=$(echo "$REPO_URL" | sed -E 's|.*v3/||')
           else
             # Remove prefix https://dev.azure.com/ and suffix /_git/...
             BASE_PATH=$(echo "$REPO_URL" | sed -E 's|https://dev.azure.com/||' | sed -E 's|/_git/.*||')
           fi
           
           # Extract Org and Project (first two components)
           # Assuming BASE_PATH is org/project/repo
           # We need just org/project
           ORG_PROJ=$(echo "$BASE_PATH" | cut -d/ -f1,2)
           
           GITOPS_REPO_URL="https://dev.azure.com/${ORG_PROJ}/_git/${APP_NAME}-gitops"
           echo "Detected Azure DevOps. Constructed GitOps URL: $GITOPS_REPO_URL"
        else
           GITOPS_REPO_URL="https://${GIT_PROVIDER}.com/${REGISTRY_NAMESPACE}/${APP_NAME}-gitops.git"
        fi

        git config --global credential.helper store
        # Extract domain from GITOPS_REPO_URL
        DOMAIN=$(echo "$GITOPS_REPO_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        echo "https://${GIT_USERNAME}:${GIT_TOKEN}@${DOMAIN}" > ~/.git-credentials
        git config --global user.email "ci@luban.com"
        git config --global user.name "Luban CI"

        echo "Cloning ${GITOPS_REPO_URL}..."
        git clone ${GITOPS_REPO_URL} /workdir/gitops
        cd /workdir/gitops
        if git show-ref --verify --quiet "refs/heads/${GITOPS_BRANCH}"; then \
          git checkout ${GITOPS_BRANCH}; \
        else \
          if git ls-remote --exit-code --heads origin ${GITOPS_BRANCH} >/dev/null 2>&1; then \
            git checkout -b ${GITOPS_BRANCH} origin/${GITOPS_BRANCH}; \
          else \
            git checkout -b ${GITOPS_BRANCH}; \
            git push -u origin ${GITOPS_BRANCH}; \
          fi; \
        fi
        
        KUST_PATH="app/overlays/${DEPLOY_ENV}/kustomization.yaml"
        BASE_DIR="app/base"
        APP_IMAGE_NAME="${registry_server}/${REGISTRY_NAMESPACE}/${APP_NAME}"
        export APP_IMAGE_NAME
        
        # Determine the image tag (identical to build steps logic)
        if printf "%s" "$GIT_REF" | grep -q '^refs/tags/'; then
          # Release Tag Logic
          IMAGE_TAG="${GIT_REF#refs/tags/}"
          IMAGE_TAG="${IMAGE_TAG#v}"
        else
          # Commit Logic
          IMAGE_TAG="${TAG:-$REVISION}"
        fi
        export IMAGE_TAG
        
        echo "Updating GitOps repo..."
        
        # Update Image Tag
        echo "Updating image tag to $IMAGE_TAG..."
        
        # Check if entry exists for APP_IMAGE_NAME
        if yq -e '.images[] | select(.name == env(APP_IMAGE_NAME))' "$KUST_PATH" >/dev/null 2>&1; then
            # Update newTag AND delete newName (to switch from placeholder alias to real image)
            yq -i 'with(.images[]; select(.name == env(APP_IMAGE_NAME)) | .newTag = env(IMAGE_TAG) | del(.newName))' "$KUST_PATH"
         else
            echo "Error: Image entry for $APP_IMAGE_NAME not found in $KUST_PATH. Please ensure the GitOps repository is correctly provisioned with an images block for this application."
            exit 1
         fi
        
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add .
          git commit -m "Update ${APP_NAME} ${DEPLOY_ENV} image tag to ${IMAGE_TAG}"
          git push
        fi
      env:
      - name: GIT_USERNAME
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: username
      - name: GIT_TOKEN
        valueFrom:
          secretKeyRef:
            name: "{{workflow.parameters.git_creds_secret}}"
            key: token
      - name: APP_NAME
        value: "{{workflow.parameters.app_name}}"
      - name: REVISION
        value: "{{workflow.parameters.revision}}"
      - name: TAG
        value: "{{workflow.parameters.tag}}"
      - name: GIT_REF
        value: "{{workflow.parameters.git_ref}}"
      - name: REPO_URL
        value: "{{workflow.parameters.repo_url}}"
      - name: GIT_PROVIDER
        value: "{{workflow.parameters.git_provider}}"
      - name: GITOPS_BRANCH
        value: "{{workflow.parameters.gitops_branch}}"
      - name: DEPLOY_ENV
        value: "{{workflow.parameters.deploy_env}}"
      - name: registry_server
        value: "{{workflow.parameters.registry_server}}"
      volumeMounts:
      - name: workdir
        mountPath: /workdir
