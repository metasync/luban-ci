apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gitops-repo-provision-template
  namespace: luban-ci
spec:
  entrypoint: provision-gitops-repo
  serviceAccountName: luban-ci-sa
  arguments:
    parameters:
      - name: project_name
        description: "Name of the project/team (e.g. dataops)"
      - name: application_name
        description: "Name of the application"
      - name: git_organization
        description: "Git Organization/User"
        value: "metasync"
      - name: git_provider
        description: "Git Provider (github, gitlab, etc.)"
        value: "github"
      - name: luban_provisioner_image
        description: "Image for the template rendering tool"
        value: "quay.io/luban-ci/luban-provisioner:0.1.16"
      # Configuration (Defaults Managed Here)
      - name: container_port
        description: "Port exposed by the container"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: default_container_port
            optional: true
      - name: service_port
        description: "Port exposed by the service"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: default_service_port
            optional: true
      - name: domain_suffix
        description: "Domain suffix for ingress/routes"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: domain_suffix
            optional: true
      - name: default_image_name
        description: "Default placeholder image name"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: default_image_name
            optional: true
      - name: default_image_tag
        description: "Default placeholder image tag"
        valueFrom:
          configMapKeyRef:
            name: luban-config
            key: default_image_tag
            optional: true

  templates:
    - name: provision-gitops-repo
      inputs:
        parameters:
          - name: project_name
          - name: application_name
          - name: git_organization
          - name: git_provider
          - name: luban_provisioner_image
          - name: container_port
          - name: service_port
          - name: domain_suffix
          - name: default_image_name
          - name: default_image_tag
      
      dag:
        tasks:
          - name: provision-repo
            template: provision-repo
            arguments:
              parameters:
                - name: project_name
                  value: "{{inputs.parameters.project_name}}"
                - name: application_name
                  value: "{{inputs.parameters.application_name}}"
                - name: git_organization
                  value: "{{inputs.parameters.git_organization}}"
                - name: git_provider
                  value: "{{inputs.parameters.git_provider}}"
                - name: luban_provisioner_image
                  value: "{{inputs.parameters.luban_provisioner_image}}"
                - name: container_port
                  value: "{{inputs.parameters.container_port}}"
                - name: service_port
                  value: "{{inputs.parameters.service_port}}"
                - name: domain_suffix
                  value: "{{inputs.parameters.domain_suffix}}"
                - name: default_image_name
                  value: "{{inputs.parameters.default_image_name}}"
                - name: default_image_tag
                  value: "{{inputs.parameters.default_image_tag}}"

    - name: provision-repo
      inputs:
        parameters:
          - name: project_name
          - name: application_name
          - name: git_organization
          - name: git_provider
          - name: luban_provisioner_image
          - name: container_port
          - name: service_port
          - name: domain_suffix
          - name: default_image_name
          - name: default_image_tag
      container:
        image: "{{inputs.parameters.luban_provisioner_image}}"
        imagePullPolicy: Always
        command: ["python3", "/app/src/main.py", "gitops"]
        args:
          - "--project-name"
          - "{{inputs.parameters.project_name}}"
          - "--application-name"
          - "{{inputs.parameters.application_name}}"
          - "--output-dir"
          - "/workdir"
          - "--container-port"
          - "{{inputs.parameters.container_port}}"
          - "--service-port"
          - "{{inputs.parameters.service_port}}"
          - "--domain-suffix"
          - "{{inputs.parameters.domain_suffix}}"
          - "--default-image-name"
          - "{{inputs.parameters.default_image_name}}"
          - "--default-image-tag"
          - "{{inputs.parameters.default_image_tag}}"
          - "--git-organization"
          - "{{inputs.parameters.git_organization}}"
          - "--git-provider"
          - "{{inputs.parameters.git_provider}}"
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-creds
                key: token
        volumeMounts:
          - name: workdir
            mountPath: /workdir
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 100Mi
