# Luban CI Configuration

# Default Shell
SHELL := /bin/sh

# Default Platform (can be overridden by PLATFORM=linux/arm64 make ...)
PLATFORM ?= linux/amd64
LIFECYCLE_VERSION := v0.20.5
LIFECYCLE_URI := https://github.com/buildpacks/lifecycle/releases/download/$(LIFECYCLE_VERSION)/lifecycle-$(LIFECYCLE_VERSION)+linux.x86-64.tgz

# Adjust Lifecycle URI if platform is arm64
ifeq ($(PLATFORM),linux/arm64)
    LIFECYCLE_URI := https://github.com/buildpacks/lifecycle/releases/download/$(LIFECYCLE_VERSION)/lifecycle-$(LIFECYCLE_VERSION)+linux.arm64.tgz
endif

# Detect Local Platform
LOCAL_ARCH := $(shell uname -m)
ifeq ($(LOCAL_ARCH),arm64)
    LOCAL_PLATFORM := linux/arm64
else ifeq ($(LOCAL_ARCH),x86_64)
    LOCAL_PLATFORM := linux/amd64
else
    LOCAL_PLATFORM := linux/$(LOCAL_ARCH)
endif

# Pack Flags
PACK_FLAGS := --target $(PLATFORM)
ifneq ($(PLATFORM),$(LOCAL_PLATFORM))
    PACK_FLAGS += --publish
endif

# --- General Settings ---
REGISTRY_SERVER := quay.io
REGISTRY_EMAIL := ci@luban.com
TAG_PREFIX := al2023
K8S_NAMESPACE := luban-ci

# --- Remote Image Configuration ---

# Quay Namespace (Organization or User)
QUAY_NAMESPACE := luban-ci

# --- Image Names (Local & Remote) ---
# We use the remote registry path as the primary image name to avoid duplication.
BUILDER_IMAGE := $(REGISTRY_SERVER)/$(QUAY_NAMESPACE)/luban-builder:$(TAG_PREFIX)
RUN_IMAGE := $(REGISTRY_SERVER)/$(QUAY_NAMESPACE)/luban-run:$(TAG_PREFIX)
BASE_IMAGE := $(REGISTRY_SERVER)/$(QUAY_NAMESPACE)/luban-base:$(TAG_PREFIX)
BUILD_IMAGE := $(REGISTRY_SERVER)/$(QUAY_NAMESPACE)/luban-build:$(TAG_PREFIX)
SAMPLE_APP_IMAGE := $(REGISTRY_SERVER)/$(QUAY_NAMESPACE)/luban-sample-app:$(TAG_PREFIX)

# Calculate Hashes
RUN_HASH := $(shell cat stack/base/Dockerfile stack/run/Dockerfile | sha256sum | awk '{print $$1}' | cut -c1-12)
BUILD_HASH := $(shell cat stack/base/Dockerfile stack/build/Dockerfile | sha256sum | awk '{print $$1}' | cut -c1-12)
BUILDER_HASH := $(shell cat stack/base/Dockerfile stack/build/Dockerfile builder.toml buildpacks/python-uv/buildpack.toml buildpacks/python-uv/bin/build | sha256sum | awk '{print $$1}' | cut -c1-12)

# Remote Tags (Immutable)
# Note: Mutable tags are now the same as the primary image names above.
REMOTE_RUN_TAG_IMMUTABLE := $(RUN_IMAGE)-$(RUN_HASH)
REMOTE_BUILD_TAG_IMMUTABLE := $(BUILD_IMAGE)-$(BUILD_HASH)
REMOTE_BUILDER_TAG_IMMUTABLE := $(BUILDER_IMAGE)-$(BUILDER_HASH)
