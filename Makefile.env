# Luban CI Configuration

# Default Shell
SHELL := /bin/sh

# Default Platform (can be overridden by PLATFORM=linux/arm64 make ...)
PLATFORM ?= linux/amd64
LIFECYCLE_VERSION := v0.20.5
LIFECYCLE_URI := https://github.com/buildpacks/lifecycle/releases/download/$(LIFECYCLE_VERSION)/lifecycle-$(LIFECYCLE_VERSION)+linux.x86-64.tgz

# Adjust Lifecycle URI if platform is arm64
ifeq ($(PLATFORM),linux/arm64)
    LIFECYCLE_URI := https://github.com/buildpacks/lifecycle/releases/download/$(LIFECYCLE_VERSION)/lifecycle-$(LIFECYCLE_VERSION)+linux.arm64.tgz
endif

# Detect Local Platform
LOCAL_ARCH := $(shell uname -m)
ifeq ($(LOCAL_ARCH),arm64)
    LOCAL_PLATFORM := linux/arm64
else ifeq ($(LOCAL_ARCH),x86_64)
    LOCAL_PLATFORM := linux/amd64
else
    LOCAL_PLATFORM := linux/$(LOCAL_ARCH)
endif

# Pack Flags
PACK_FLAGS := --target $(PLATFORM)
ifneq ($(PLATFORM),$(LOCAL_PLATFORM))
    PACK_FLAGS += --publish
endif

# --- General Settings ---
REGISTRY_SERVER := quay.io
REGISTRY_EMAIL := ci@luban.com
TAG_PREFIX := al2023
K8S_NAMESPACE := luban-ci
ARGOCD_NAMESPACE := argocd
REGISTRY_NAMESPACE := luban-ci
AZURE_ORGANIZATION := metasync
GITHUB_ORGANIZATION := metasync

# --- Shared Image Names (for reference) ---
BUILDER_IMAGE := $(REGISTRY_SERVER)/$(REGISTRY_NAMESPACE)/luban-builder:$(TAG_PREFIX)
RUN_IMAGE := $(REGISTRY_SERVER)/$(REGISTRY_NAMESPACE)/luban-run:$(TAG_PREFIX)
APP_NAME := luban-hello-world-py
APP_REVISION := main

# Buildpack Configuration
BUILDPACK_IMAGE := $(REGISTRY_SERVER)/$(REGISTRY_NAMESPACE)/python-uv:0.0.10
